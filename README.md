# CS:GOrner

## Development

Project consists of React frontend and AWS Amplify Api -backend (graphql).
Only two branches, dev and master, are in use for now (Amplify creates backends per branch).

Amplify documentation:
https://docs.amplify.aws/lib/q/platform/js

### Setup

1. Install amplify-cli: `npm install -g @aws-amplify/cli`
2. Configure AWS profile: `amplify configure` (This should make .aws/ and .amplify/ folders in you home dir)
    - accessKeyId: < Your IAM user accessKeyId >
    - accessKeyId: < Your IAM user accessKeyId >
    - region: eu-west-1
3. Clone repository: `https://github.com/odporkka/CS-GOrner.git`
4. Pull packend env: `amplify pull`
    - Use your configured amplify profile and dev env or make a new one
    - You can check the env with `amplify status`
4. Install packages: `npm install`


### Workflow
1. Checkout dev branch `git checkout dev`. (Amplify adjusts API environment based on this.)
2. Run locally `npm start` and view on localhost:3000
3. For backend changes (schema.graphql) you can test locally without publishing with `amplify mock api`.
Command also gives url to access GraphiQL explorer on local port. For viewing api and app in AWS console
you can use `amplify console`. !! NOTE: Does not work on `@searchable` models
4. To publish changes to backend, run `amplify push`. This publishes for branch you are working on
(should always be dev).
5. Run and fix tests `npm test`
6. When satisfied, merge dev to prod: `git checkout master && git merge --no-ff development`.
7. To deploy to prod, run `amplify publish`.


### Project structure:
- amplify/: AWS Amplify stuff
  - You should usually only need to touch `/backend/api/csgorner/schema.graphql`, everything else is automated.
- node_modules/: Installed libraries (duh).
- public/: index.html and assets (most assets should be in S3 bucket).
- src/:
  - backend/: All things related to backend API.
  - components/: All React components.
    - views/: "pages" of app.
  - context/: App "state".
  - graphql/: Autogenerated graphql queries. For reference only, use the ones in the backend/ folder.
  - util/: Helper classes.

### npm scripts
#### `npm start`

Runs the app in the development mode.<br />
Open [http://localhost:3000](http://localhost:3000) to view it in the browser.

The page will reload if you make edits.<br />
You will also see any lint errors in the console.

#### `npm test`

Launches the test runner in the interactive watch mode.<br />
See the section about [running tests](https://facebook.github.io/create-react-app/docs/running-tests) for more information.

#### `npm run build`

Not needed to run manually. Use `amplify publish` to deploy (after checking out master branch). 

#### `npm run eject`

**Note: this is a one-way operation. Once you `eject`, you canâ€™t go back!**

If possible, avoid this!

## Authentication/Security
To update auth settings run `amplify update auth`  
This will lead you through update process..

There is multi-auth setup in this project.
API_KEY is used as default and COGNITO_USER_POOLS for authenticated users.

## GraphQL API

### Updating API access policies
Access policies can be updated in `graphql.schema`.  
Basic syntax to allow/restrict access is:
```
    @auth(
        rules: [
            { allow: public, provider: apiKey, operations: [read]},
            { allow: groups, provider: userPools, groups: ["Editors"]}
        ]
    )
```
#### Public access
Default AppSync auth method is API_KEY, this is used for public access on resources. API key is bundled with frontend
automatically.  

(There should be line `"aws_appsync_authenticationType": "API_KEY"` in `aws-exports.js`.)
 
Public access include only READ access on: Maps, Posts, Comments etc.  

#### Cognito users
**Editor rights** are for authenticated users in "Editors" group.

These include READ/WRITE/UPDATE/DELETE on their own Posts. Editors can log in at `/admin` endpoint with their own AWS user.

**Administrator rights** are for authenticated users in "Administrators" group.

These include READ/WRITE/UPDATE/DELETE on ALL Posts. Administrators can log in at `/admin` endpoint with their own AWS user.

## Tests
Testing is done with Jest and React Testing Library. Focus is on integration testing over excessive unit testing.

Tests structure:
- \_\_tests__: 
    - App.test.js: Test context, navigation and content which is always shown
- \_\_mocks__:
    - mockData.js: Predefined data that is used for testing
- components/views/\_\_tests__:
    - View.test.jsx(s): Tests for all views. These use mocked context providers and
    test only view components. Main functionality is tested here.
- util/\_\_tests__:
    - util.test.js(s): Tests for util classes. These are strictly unit tests.
- util/testUtil.js: General utils for tests. Most importantly helper functions for rendering components with
predefined context and router

#### Mocks
- Backend/api.js: Mocked since mocking Amplifys API.graphql separately for every query is too troublesome.
    - Remember to mock separate api functions in tests!
- Auth: AWS Auth functions need to be mocked since we are not using AWS in tests.
- window: window-object functions need to be mocked
